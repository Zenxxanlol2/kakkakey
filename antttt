local output = ""
local captured = {}
local seen_tables = {}

-- Safe file writing that checks for available functions
local function write(file, data)
    if writefile then
        return pcall(writefile, file, data)
    elseif syn and syn.writefile then
        return pcall(syn.writefile, file, data)
    else
        -- No file writing available, just print to console
        print("[!] No writefile function available")
        print("[!] Dump contents:")
        print(data)
        return false
    end
end

-- Safe clipboard that checks for available functions
local function clip(text)
    if setclipboard then
        return pcall(setclipboard, text)
    elseif syn and syn.write_clipboard then
        return pcall(syn.write_clipboard, text)
    elseif toclipboard then
        return pcall(toclipboard, text)
    else
        print("[!] No clipboard function available")
        return false
    end
end

local og_unpack = unpack or table.unpack
local og_load = loadstring or load

-- Simple safe table access
local function safe_get(t, k)
    local success, value = pcall(function()
        return rawget(t, k)
    end)
    return success and value or nil
end

-- Minimal formatter with strict limits
local function fmt(tbl, indent, depth)
    indent = indent or 0
    depth = depth or 0
    
    -- Strict depth limit
    if depth > 5 then
        return "[max_depth]"
    end
    
    -- Check if we've seen this table
    local table_id = tostring(tbl):match("table: (%x+)")
    if seen_tables[table_id] then
        return "[circular]"
    end
    seen_tables[table_id] = true
    
    local spacing = string.rep("  ", indent)
    local result = "{"
    local count = 0
    
    -- Process numeric indices first (limited)
    for i = 1, 100 do
        if count >= 30 then break end
        local value = safe_get(tbl, i)
        if value == nil then break end
        
        local value_str
        if type(value) == "table" then
            value_str = fmt(value, indent + 1, depth + 1)
        elseif type(value) == "string" then
            if #value > 100 then
                value_str = string.format("%q", value:sub(1, 100) .. "...")
            else
                value_str = string.format("%q", value)
            end
        else
            value_str = tostring(value)
        end
        
        result = result .. string.format("\n%s[%d] = %s,", spacing .. "  ", i, value_str)
        count = count + 1
    end
    
    -- Process some non-numeric keys (very limited)
    local key_count = 0
    for k, v in pairs(tbl) do
        if count >= 50 then break end
        if key_count >= 10 then break end
        if type(k) == "number" and k >= 1 and k <= 100 then
            -- Already processed numeric keys
            goto continue
        end
        
        local value_str
        if type(v) == "table" then
            value_str = "[table]"
        elseif type(v) == "string" then
            if #v > 50 then
                value_str = string.format("%q", v:sub(1, 50) .. "...")
            else
                value_str = string.format("%q", v)
            end
        else
            value_str = tostring(v)
        end
        
        local key_str = type(k) == "string" and string.format("%q", k) or tostring(k)
        result = result .. string.format("\n%s[%s] = %s,", spacing .. "  ", key_str, value_str)
        count = count + 1
        key_count = key_count + 1
        
        ::continue::
    end
    
    if count >= 50 then
        result = result .. "\n" .. spacing .. "  -- ... (truncated)"
    end
    
    result = result .. "\n" .. spacing .. "}"
    seen_tables[table_id] = nil
    return result
end

-- Safe unpack hook
function unpack(...)
    local args = {...}
    local t = args[1]
    
    if type(t) == "table" then
        print("[*] Capturing table...")
        
        -- Reset seen tables
        seen_tables = {}
        
        local success, formatted = pcall(function()
            return fmt(t)
        end)
        
        if success then
            output = output .. "\n-- Table --\n" .. formatted .. "\n"
            table.insert(captured, t)
            print("[+] Table captured")
        else
            output = output .. "\n-- Error: " .. tostring(formatted) .. " --\n"
            print("[-] Capture failed:", formatted)
        end
    end
    
    return og_unpack(...)
end

-- Loadstring hook
loadstring = function(code, ...)
    if type(code) == "string" then
        if code:find("return function") and code:find("local d=") then
            print("[*] Moonsec detected")
        end
    end
    return og_load(code, ...)
end

local function save()
    local file = "dump_" .. os.time() .. ".txt"
    
    -- Truncate output if too long
    local display_output = output
    if #output > 50000 then
        display_output = output:sub(1, 50000) .. "\n\n... (truncated)"
    end
    
    local result = string.format([[
DUMP RESULTS
Time: %s
Tables: %d

%s
]], os.date("%Y-%m-%d %H:%M:%S"), #captured, display_output)
    
    local write_success = write(file, result)
    if write_success then
        print("[+] Saved:", file)
    else
        print("[-] Could not save to file, printing to console instead")
    end
    
    local clip_success = clip(result)
    if clip_success then
        print("[+] Copied to clipboard")
    else
        print("[-] Could not copy to clipboard")
    end
end

print("[*] Simple dumper ready")
print("[*] Execute obfuscated script")

-- Auto save
task.spawn(function()
    task.wait(10)
    if #captured > 0 then
        save()
    else
        print("[-] No tables captured")
    end
end)
