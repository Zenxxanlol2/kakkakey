local output = ""
local captured = {}
local seen_tables = {}
local bypass_mode = true

local function write(file, data)
    if writefile then
        writefile(file, data)
        return true
    end
    warn("no write function available")
    return false
end

local function clip(text)
    if setclipboard then
        setclipboard(text)
        return true
    elseif toclipboard then
        toclipboard(text)
        return true
    end
    return false
end

local og_unpack = unpack or table.unpack
local og_load = loadstring
local og_pairs = pairs
local og_ipairs = ipairs

-- Safe table access that handles readonly tables
local function safe_table_access(t, k)
    if type(t) ~= "table" then return nil end
    
    local success, value = pcall(function()
        return rawget(t, k)
    end)
    
    if success then
        return value
    end
    
    -- If rawget fails, try other methods
    success, value = pcall(function()
        return t[k]
    end)
    
    return success and value or nil
end

-- Safe length check for protected tables
local function safe_table_length(t)
    if type(t) ~= "table" then return 0 end
    
    local success, length = pcall(function()
        return #t
    end)
    
    if success then
        return length
    end
    
    -- Fallback: count numeric indices manually
    local count = 0
    for i = 1, 1000 do
        local success, value = pcall(function()
            return rawget(t, i)
        end)
        if success and value ~= nil then
            count = count + 1
        else
            break
        end
    end
    return count
end

-- Safe pairs iteration for protected tables
local function safe_pairs(t)
    if type(t) ~= "table" then return function() end end
    
    return function(_, last_key)
        local success, key, value = pcall(function()
            -- Use next with rawget bypass
            return next(t, last_key)
        end)
        
        if success and key ~= nil then
            return key, value
        end
        return nil
    end, t, nil
end

-- Safe ipairs iteration for protected tables
local function safe_ipairs(t)
    if type(t) ~= "table" then return function() end end
    
    local i = 0
    return function()
        i = i + 1
        local success, value = pcall(function()
            return rawget(t, i)
        end)
        
        if success and value ~= nil then
            return i, value
        end
        return nil
    end
end

-- Enhanced formatter that handles readonly tables
local function fmt(tbl, indent, depth, path)
    indent = indent or 0
    depth = depth or 0
    path = path or ""
    
    -- Anti-recursion protection
    if depth > 10 then
        return "[depth_limit]"
    end
    if seen_tables[tbl] then
        return "[seen]"
    end
    seen_tables[tbl] = true
    
    local spacing = string.rep("  ", indent)
    local result = "{"
    local count = 0
    
    -- Safe table iteration that won't modify readonly tables
    local function safe_iterate()
        local items = {}
        
        -- Try numeric indices first with safe access
        local length = safe_table_length(tbl)
        for i = 1, math.min(50, length) do
            if count >= 50 then break end
            
            local success, value = pcall(function()
                return rawget(tbl, i)
            end)
            
            if success and value ~= nil then
                items[#items + 1] = {index = i, value = value, type = type(value)}
                count = count + 1
            end
        end
        
        -- Try key-value pairs with safe access (limited)
        local pair_count = 0
        for k, v in safe_pairs(tbl) do
            if pair_count >= 30 then break end -- Limit non-numeric keys
            if count >= 80 then break end -- Total limit
            
            -- Skip numeric keys we already processed
            if type(k) ~= "number" or k > length or k < 1 then
                local success = pcall(function()
                    -- Just check if we can access it without modifying
                    return rawget(tbl, k)
                end)
                
                if success then
                    items[#items + 1] = {index = k, value = v, type = type(v)}
                    count = count + 1
                    pair_count = pair_count + 1
                end
            end
        end
        
        return items
    end
    
    local success, items = pcall(safe_iterate)
    
    if not success then
        seen_tables[tbl] = nil
        return "[readonly_table_access_failed]"
    end
    
    for _, item in ipairs(items) do
        local index_str
        if type(item.index) == "string" then
            index_str = string.format("%q", item.index)
        else
            index_str = tostring(item.index)
        end
        
        local value_str
        if item.type == "table" then
            local new_path = path .. "[" .. tostring(item.index) .. "]"
            value_str = fmt(item.value, indent + 1, depth + 1, new_path)
        elseif item.type == "string" then
            -- Truncate very long strings
            if #item.value > 200 then
                value_str = string.format("%q", item.value:sub(1, 200) .. "...[truncated]")
            else
                value_str = string.format("%q", item.value)
            end
        elseif item.type == "function" then
            value_str = "[function]"
        elseif item.type == "userdata" then
            value_str = "[userdata]"
        else
            value_str = tostring(item.value)
        end
        
        result = result .. string.format("\n%s[%s] = %s,", spacing .. "  ", index_str, value_str)
    end
    
    if count >= 80 then
        result = result .. "\n" .. spacing .. "  -- ... (truncated)"
    end
    
    result = result .. "\n" .. spacing .. "}"
    seen_tables[tbl] = nil
    return result
end

-- Hook unpack with readonly protection
function unpack(...)
    local args = {...}
    local t = args[1]
    
    if type(t) == "table" then
        print("[*] Attempting to capture table (readonly-safe)...")
        
        -- Reset seen tables
        seen_tables = {}
        
        local success, formatted = pcall(function()
            return fmt(t)
        end)
        
        if success then
            output = output .. "\n-- Table Capture --\n" .. formatted .. "\n\n"
            table.insert(captured, {original = t, data = formatted})
            print("[*] Successfully captured table (readonly-safe)")
        else
            local error_msg = tostring(formatted)
            output = output .. "\n-- Failed to capture table: " .. error_msg .. " --\n\n"
            
            -- Try minimal capture for readonly tables
            local minimal_info = string.format("[readonly_table: %d elements?]", safe_table_length(t))
            output = output .. minimal_info .. "\n\n"
            print("[!] Table capture limited (readonly):", error_msg)
        end
    end
    
    return og_unpack(...)
end

-- Enhanced loadstring hook
loadstring = function(code, ...)
    if type(code) == "string" then
        if code:find("return function") and code:find("local d=") then
            print("[*] Moonsec V3 detected - activating readonly bypass")
            bypass_mode = true
        end
        
        -- Detect table protection patterns
        if code:find("setreadonly") or code:find("make_readonly") or code:find("lock%)") then
            print("[*] Readonly table protection detected")
        end
    end
    
    local success, result = pcall(og_load, code, ...)
    if success then
        return result
    else
        print("[!] Loadstring error:", result)
        return nil, result
    end
end

local function save()
    local file = "dump_" .. os.time() .. ".txt"
    local result = string.format([[
========================================
READONLY-SAFE DUMP RESULTS
========================================
Capture Time: %s
Tables Attempted: %d
Bypass Mode: %s

%s
========================================
]], os.date("%Y-%m-%d %H:%M:%S"), #captured, tostring(bypass_mode), output)
    
    if write(file, result) then
        print("[+] Saved:", file)
    end
    if clip(result) then
        print("[+] Copied to clipboard")
    end
    print("[+] Complete, tables attempted:", #captured)
end

-- Safe initialization
if game then
    local success = pcall(function()
        game:GetService("Players").LocalPlayer:GetPropertyChangedSignal("Parent"):Connect(save)
    end)
    if not success then
        print("[*] Using alternative trigger method")
    end
end

print("[*] Readonly-safe dumper ready")
print("[*] Execute obfuscated script now")

-- Auto-save with protection
task.spawn(function()
    task.wait(8)
    local success = pcall(function()
        if #captured > 0 then
            save()
        else
            print("[!] No tables captured within timeout period")
        end
    end)
    if not success then
        print("[!] Auto-save failed")
    end
end)
